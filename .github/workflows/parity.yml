name: Parity Test
run-name: Parity Test - ${{ inputs.test_suite }}

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: Select which test suite to run
        type: choice
        required: true
        default: all
        options:
          - all
          - fast_all_parity
          - rssp_unique_parity
          - hash_parity
          - bpm_parity
          - metadata_parity
          - step_counts_parity
          - duration_parity
          - nps_parity
          - breakdown_parity
          - tech_counts_parity
          - timing_parity
      pack_filter:
        description: Comma-separated pack name filters (matches path under tests/data/packs); use "all" for everything
        type: string
        required: false
        default: all

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Parity Test - ${{ inputs.test_suite }}
    runs-on: self-hosted 

    steps:
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
        
    - name: Run Tests
      shell: bash
      run: |
        set -euo pipefail
        PARITY_LOG="$RUNNER_TEMP/parity_output.txt"
        : > "$PARITY_LOG"
        exec > >(tee -a "$PARITY_LOG") 2>&1
        pack_input="${{ inputs.pack_filter }}"
        if [[ -z "$pack_input" || "$pack_input" == "all" ]]; then
          pack_filters=("")
        else
          IFS=',' read -r -a pack_filters <<< "$pack_input"
        fi

        run_suite() {
          local filter="$1"
          local -a extra_args=()
          if [[ -n "$filter" ]]; then
            extra_args=(-- "$filter")
          fi

          case "${{ inputs.test_suite }}" in
            all)
              cargo test --release --verbose --test all_parity "${extra_args[@]}"
              ;;
            "all alternative")
              cargo test --release --verbose --test rssp_unique_parity "${extra_args[@]}"
              ;;
            *)
              cargo test --release --verbose --test "${{ inputs.test_suite }}" "${extra_args[@]}"
              ;;
          esac
        }

        ran_any=0
        for raw_filter in "${pack_filters[@]}"; do
          filter="$(echo "$raw_filter" | xargs)"
          if [[ -n "$filter" ]]; then
            echo "Running with pack filter: $filter"
            run_suite "$filter"
            ran_any=1
          fi
        done

        if [[ "$ran_any" -eq 0 ]]; then
          run_suite ""
        fi

    - name: Summarize Failures
      if: ${{ always() }}
      shell: bash
      run: |
        set -euo pipefail
        PARITY_LOG="$RUNNER_TEMP/parity_output.txt"
        if [[ ! -s "$PARITY_LOG" ]]; then
          {
            echo "## Parity Failures"
            echo
            echo "No log output captured."
          } >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        failures="$(awk '
          /^failures:$/ {in_block=1}
          in_block {print}
          in_block && /^test result:/ {in_block=0}
        ' "$PARITY_LOG")"

        {
          echo "## Parity Failures"
          echo
          if [[ -n "$failures" ]]; then
            echo '```'
            echo "$failures"
            echo '```'
          else
            echo "No failures reported."
          fi
        } >> "$GITHUB_STEP_SUMMARY"
